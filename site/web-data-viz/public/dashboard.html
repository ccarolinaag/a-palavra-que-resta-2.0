<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>a palavra que resta</title>

    <link rel="icon" href="assets/icons/p.svg" type="image/x-icon">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/styleDashboard.css">

    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <header>
        <ul class="lista-header">
            <li>
                <div class="list-content">
                    <a href="dashboard.html">informações de leitura</a>
                </div>
            </li>
            <li>
                <div class="list-content">
                    <a href="livros.html">livros</a>
                </div>
            <li>
                <div class="list-content">
                    <a href="feed.html">feed</a>
                </div>
            </li>
            <li>
                <div class="list-content">
                    <a href="game.html">escrita livre</a>
                </div>
            </li>
        </ul>
        <div class="name-nav">
            <a href="index.html">
                <img src="assets/icons/sair.svg" alt="botão sair">
            </a>
            </nav>
    </header>
    <main>
        <div class="container1">
            <div class="apresentacao">
                <h3 id="b_usuario"></h3>
            </div>
            <div class="linha1">
                <div class="forma-grande">
                    <h4>livros lidos</h4>
                    <p id="kpi_lidos"></p>
                </div>
            </div>
            <div class="linha2">
                <div class="forma-pequena">
                    <h4>tempo médio por livro</h4>
                    <p id="kpitempomedio"></p>
                    <h6>dias</h6>
                </div>
                <div class="forma-pequena">
                    <h4>páginas por semana</h4>
                    <p id="kpi_paginasSemana"></p>
                    <h6>páginas</h6>
                </div>
            </div>
            <div class="linha3">
                <div class="forma-pequena">
                    <h4>quero ler</h4>
                    <p>0</p>
                </div>
                <div class="forma-pequena">
                    <h4>favoritos</h4>
                    <p>0</p>
                </div>
            </div>
        </div>
        <div class="container2">
            <div class="indicacao-ano">
                No último ano você...
            </div>
            <div class="linha1">
                <div class="forma-grande">
                    <h4>leu</h4>
                    <p id="kpi_lidosAno"></p>
                    <h6>livros</h6>
                </div>
                <div class="forma-grande">
                    <h4>mês com mais leituras</h4>
                    <p id="maiorMes"></p>
                    <h6>quantas aventuras!</h6>
                </div>
            </div>
            <div class="grafico">
                <canvas id="myChart"></canvas>
            </div>
        </div>
    </main>
</body>

<script>                    
    b_usuario.innerHTML = "Olá, " + sessionStorage.NOME_USUARIO + "!";
    buscarDados();
    buscarDadosAno();


    function buscarDados() {
        var idUser = sessionStorage.ID_USUARIO;

        fetch("usuarios/buscarLivrosUsuario", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idUserServer: idUser })
        })
            .then(async resposta => {
                console.log("ESTOU NO THEN DO buscarDados()!");

                const livros = await resposta.json();
                console.log("LIVROS DO USUÁRIO:", livros);

                calcularKPIS(livros)
            })
            .catch(err => console.error("Erro geral:", err));


    }

    function buscarDadosAno() {
        var idUser = sessionStorage.ID_USUARIO;
        fetch("usuarios/buscarDadosAno", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idUserServer: idUser })
        })
            .then(async resposta => {
                console.log("ESTOU NO THEN DO buscarDadosAno()!");

                const reporte = await resposta.json();
                console.log("DADOS DO ANO:", reporte);

                calcularKPISano(reporte);
            })
            .catch(err => console.error("Erro geral:", err));
    }

    function calcularKPIS(livros) {
        kpiLivrosLidos(livros);
        kpiTempoMedio(livros);
        kpiPgSemana(livros);
    }

    function kpiLivrosLidos(livros) {
        qtd = livros.length
        kpi_lidos.innerHTML = qtd;
    }

    function kpiTempoMedio(livros) {
        let vt_dias = []; // vetor tempo em dias

        for (let i = 0; i < livros.length; i++) {
            let inicio = new Date(livros[i].dtinicio); // "2025-12-17 T03:24:00"  semana, dia, mês, ano, fuso horário e hora
            let fim = new Date(livros[i].dttermino);

            let diferencaMiseg = fim - inicio;

            let diferencaDias = diferencaMiseg / (1000 * 60 * 60 * 24);

            vt_dias.push(diferencaDias);
        }

        let soma = 0;
        for (let i = 0; i < vt_dias.length; i++) {
            soma += vt_dias[i];
        }

        let media = 0;
        if (vt_dias.length > 0) {
            media = soma / vt_dias.length;
        }
        kpitempomedio.innerHTML = media.toFixed(0);

    }

    function kpiPgSemana(livros) {
        let vt_media_livro = [];

        for (let i = 0; i < livros.length; i++) {
            let inicio = new Date(livros[i].dtinicio); // "2025-12-17 T03:24:00"
            let fim = new Date(livros[i].dttermino);

            let diferencaMiseg = fim - inicio;

            let diferencaSemanas = diferencaMiseg / (1000 * 60 * 60 * 24 * 7);

            let media = livros[i].numpaginas / diferencaSemanas;

            vt_media_livro.push(media)
        }

        let somaMedias = 0;
        for (let i = 0; i < vt_media_livro.length; i++) {
            somaMedias += vt_media_livro[i];
        }

        let mediaPaginasSemanas = 0;
        if (vt_media_livro.length > 0) {
            mediaPaginasSemanas = somaMedias / vt_media_livro.length;
        }

        kpi_paginasSemana.innerHTML = mediaPaginasSemanas.toFixed();

    }

    function calcularKPISano(reporte) {
        var vt_Dados_Meses = [];

        if (reporte.length <= 0) {
            vt_Dados_Meses = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            kpi_lidosAno.innerHTML = 0;

            
            maiorMes.innerHTML = "nenhum";

            
            plotarGrafico(vt_Dados_Meses);

            return; 
        }
        else {
            vt_Dados_Meses[0] = Number(reporte[0].janeiro);
            vt_Dados_Meses[1] = Number(reporte[0].fevereiro);
            vt_Dados_Meses[2] = Number(reporte[0].marco);
            vt_Dados_Meses[3] = Number(reporte[0].abril);
            vt_Dados_Meses[4] = Number(reporte[0].maio);
            vt_Dados_Meses[5] = Number(reporte[0].junho);
            vt_Dados_Meses[6] = Number(reporte[0].julho);
            vt_Dados_Meses[7] = Number(reporte[0].agosto);
            vt_Dados_Meses[8] = Number(reporte[0].setembro);
            vt_Dados_Meses[9] = Number(reporte[0].outubro);
            vt_Dados_Meses[10] = Number(reporte[0].novembro);
            vt_Dados_Meses[11] = Number(reporte[0].dezembro);
        }

        console.log("REPORTE:", reporte[0]);

        var soma = 0;
        for (i = 0; i < vt_Dados_Meses.length; i++) {
            soma += vt_Dados_Meses[i];
        }
        kpi_lidosAno.innerHTML = soma;

        var maior = 0;
        var mesMaior = "";

        var meses = [
            "janeiro", "fevereiro", "marco", "abril", "maio", "junho",
            "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"
        ];

        for (var i = 0; i < meses.length; i++) {

            var nomeMes = meses[i];
            var valor = Number(reporte[0][nomeMes]);

            if(nomeMes == "marco") {
                nomeMes = "Março"
            }

            if (valor > maior) {
                maior = valor;
                mesMaior = nomeMes;
            }
        }

        if (maior === 0) {
            maiorMes.innerHTML = "nenhum";
        } else {
            maiorMes.innerHTML = mesMaior;
        }

        plotarGrafico(vt_Dados_Meses);
    }

    function plotarGrafico(vtMeses) {

        console.log('iniciando plotagem do gráfico...');
        console.log("Dados do gráfico:", vtMeses);

        let labels = [
            "Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho",
            "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"
        ];

        let dados = {
            labels: labels,
            datasets: [{
                label: 'Livros lidos',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.4)',
                tension: 0.1
            }]
        };

        for (let i = 0; i < vtMeses.length; i++) {
            dados.datasets[0].data.push(vtMeses[i]);
        }

        const config = {
            type: 'bar',
            data: dados
        };

        new Chart(
            document.getElementById("myChart"),
            config
        );
    }
</script>

</html>